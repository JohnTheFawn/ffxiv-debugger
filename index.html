<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="text/javascript" src="https://ngld.github.io/OverlayPlugin/assets/shared/common.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body{
        margin: 0px;
        font-family: Lucida Sans Unicode,sans-serif;
        background-color: #d2d2d2;
      }

      #main{
      }

      .card{
        background-color: white;
        border: 1px solid #c2c2c2;
        border-radius: 8px;
        padding: 8px;
        margin: 8px;
        -webkit-box-shadow: 2px 2px 3px 0px rgba(0,0,0,0.2);
        -moz-box-shadow: 2px 2px 3px 0px rgba(0,0,0,0.2);
        box-shadow: 2px 2px 3px 0px rgba(0,0,0,0.2);
      }

      .gainedEffectFriendlyView{
        cursor: pointer;
        margin: -8px;
        padding: 8px;
        transition: background-color .075s ease-out;
        border-radius: 8px;
      }

      .gainedEffectContainer[open] > .gainedEffectFriendlyView{
        margin-bottom: 8px;
        border-bottom: 1px solid #c2c2c2;
      }

      .gainedEffectFriendlyView:hover{
        background-color: rgba(0, 0, 0, 0.1);
      }

      .gainedEffectDetailsTable{
        width: 100%;
      }

      .gainedEffectDetailsTable, .gainedEffectDetailsTable tr {
        border: 1px solid #c2c2c2;
        border-collapse: collapse;
      }

      .gainedEffectDetailsTable td:nth-child(3){
        border-left: 1px solid #c2c2c2;
      }

      .gainedEffectDetailsTable td {
        padding-right: 8px;
        padding-left: 8px;
      }

      .gainedEffectCodeContainer{
        border: 1px solid #c2c2c2;
        border-radius: 8px;
        padding: 8px;
        margin-top: 8px;
        background: rgba(0, 0, 0, .03);
      }

      .preventSelect{
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10 and IE 11 */
        user-select: none; /* Standard syntax */
      }

      .wordWrapAnywhere{
        word-wrap: anywhere;
      }
    </style>
  </head>
  <body>
    <div id="main">
    </div>
  </body>
  <footer>
    <script>
      const debug = true;
      if(debug){
        console.log('debug', debug);
      }

      // Will be set to the name of the current character
      let characterName = null;

      // Contents vary based on messageType
      const eventType = 'LogLine';
      // 0: messageType?
      //    00: message in chat box
      //        ex: "Tonk Tonkers: hello", "There are no party members." "You change to paladin."
      //    21: use action
      //        ex: clicking a button on your hotbar such as Sentinel or Goring Blade or Arm's Length
      //    26: gained an effect
      //        ex: getting a buff like Rampart or Sentinel or Arm's Length
      //    30: lose an effect
      //        ex: Rampart or Sentinel or Arm's Length wears off
      // TODO function to parse this message type?
      //    ex: "21|2023-01-16T13:37:49.1410000-05:00|107CDF82|Tonk Tonkers|16|Bulwark|107CDF82|Tonk Tonkers|640F|4D8000|0|0|0|0|0|0|0|0|0|0|0|0|0|0|98900|98900|10000|10000|||-87.90|51.12|1.50|-1.54|98900|98900|10000|10000|||-87.90|51.12|1.50|-1.54|0000130D|0|1|81681bf499192d9b"
      //        messageType: 21
      //        timestamp: 2023-08-08T17:49:10.1180000-04:00
      //        actorId: 10911F96
      //        actorName: Tonk Tonkers
      //        action id: DE0
      //        action: Equilibrium
      //        targetId: 10911F96
      //        targetName: Tonk Tonkers
      //        ???: 4
      //        amount (hex, trailing 0s?): 6D510000
      //    ex: "26|2023-01-16T13:37:49.1410000-05:00|4D|Bulwark|10.00|107CDF82|Tonk Tonkers|107CDF82|Tonk Tonkers|00|98900|98900|b7ca294ce31f8663"
      //        messageType: 26
      //        timestamp: 2023-01-16T13:37:49.1410000-05:00
      //        actionId: 4D
      //        actionName: Bulwark
      //        duration (seconds, 2 decimal places): 10.00
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        targetId: 107CDF82
      //        targetName: Tonk Tonkers
      function parseMessageGainEffect(message){
        return {
          messageType: message.line[0],
          timestamp: new Date(message.line[1]),
          actionId: message.line[2],
          actionName: message.line[3],
          duration: message.line[4],
          actorId: message.line[5],
          actorName: message.line[6],
          targetId: message.line[7],
          targetName: message.line[8]
        };
      }
      function createFakeMessageGainEffectMessage(){
        return {
          line: [
            26,
            new Date().toISOString(),
            '4D',
            'Bulwark',
            10.00,
            '107CDF82',
            'Tonk Tonkers',
            '107CDF82',
            'Tonk Tonkers'
          ]
        }
      }
      // TODO function to parse this message type
      //    ex: "30|2023-01-16T13:37:53.8630000-05:00|4D|Bulwark|0.00|107CDF82|Tonk Tonkers|107CDF82|Tonk Tonkers|00|98900|98900|ebfc01ff60fa6c8f"
      //        messageType: 30
      //        timestamp: 2023-01-16T13:37:53.8630000-05:00
      //        actionId: 4D
      //        actionName: Bulwark
      //        duration (seconds, 2 decimal places): 0.00
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        target?Id: 107CDF82
      //        target?Name: Tonk Tonkers

      // We only want a few of the message types
      // Character uses ability: Display something in the overlay to so it feels
      //                         responsive?
      // Character gains effect: Communicate that the character has the effect
      // Character loses effect: Communicate that the character no longer has
      //                         the effect
      const MESSAGE_TYPE_USE_ABILITY = '21'; // Character uses ability
      const MESSAGE_TYPE_GAIN_EFFECT = '26'; // Character gains effect
      const MESSAGE_TYPE_LOSE_EFFECT = '30'; // Character loses effect
      // All Message Types
      const messageTypes = [
        MESSAGE_TYPE_USE_ABILITY,
        MESSAGE_TYPE_GAIN_EFFECT,
        MESSAGE_TYPE_LOSE_EFFECT
      ];

      const messageTypeToFriendlyMap = {
        [MESSAGE_TYPE_USE_ABILITY]: 'Used an ability',
        [MESSAGE_TYPE_GAIN_EFFECT]: 'Gained an effect',
        [MESSAGE_TYPE_LOSE_EFFECT]: 'Lost an effect',
      };

      const effects = [];

      addOverlayListener(eventType, (data) => {
        const messageType = data.line[0];
        if(messageTypes.includes(messageType)){
          switch(messageType){
            case MESSAGE_TYPE_USE_ABILITY:
              if(debug){
                console.log('Used an ability');
                console.log(data);
              }
              break;
            case MESSAGE_TYPE_GAIN_EFFECT:
              if(debug){
                console.log('Gained an effect');
                console.log(data);
              }
              const message = parseMessageGainEffect(data);
              if(debug){
                console.log(message);
              }
              effects.push(message);

              appendElementToMain(
                createGainedEffectElement(
                  data
                )
              );

              break;
            case MESSAGE_TYPE_LOSE_EFFECT:
              if(debug){
                console.log('Lost an effect');
                console.log(data);
              }
              break;
          }
        }
      });
      // Set the player's character name so we know who they are later
      addOverlayListener('ChangePrimaryPlayer', (data) => {
        characterName = data.charName;
      });
      startOverlayEvents();

      /**
       * Add a string to the page
       *
       * @param {string} content The string to add to the page
       */
      function appendStringToMain(content){
        const mainElement = document.getElementById('main');
        const newElement = document.createElement('div');
        newElement.innerHTML = content;
        mainElement.appendChild(newElement);
      }

      /**
       * Add a json object to the page
       *
       * @param {object} json The json to be added to the page
       */
      function appendJsonToMain(json){
        const mainElement = document.getElementById('main');
        const newElement = document.createElement('code');
        newElement.innerHTML = JSON.stringify(json);
        mainElement.appendChild(newElement);
      }

      function appendElementToMain(element){
        document.getElementById('main').appendChild(element);
      }

      function createUsedAbilityElement(abilityMessage){

      }

      function createGainedEffectTable(effectMessage){
        const detailsTable = document.createElement('table');
        detailsTable.classList.add('gainedEffectDetailsTable');

        const firstRow = createTableRowFromArray([
          'Actor',
          effectMessage.actorName,
          'Action',
          effectMessage.actionName
        ]);
        detailsTable.appendChild(firstRow);

        const secondRow = createTableRowFromArray([
          'Actor ID',
          effectMessage.actorId,
          'Action ID',
          effectMessage.actionId
        ]);
        detailsTable.appendChild(secondRow);

        const thirdRow = createTableRowFromArray([
          'Target',
          effectMessage.targetName,
          'Duration',
          effectMessage.duration
        ]);
        detailsTable.appendChild(thirdRow);

        const fourthRow = createTableRowFromArray([
          'Target ID',
          effectMessage.targetId,
          'Message Type',
          effectMessage.messageType
        ]);
        detailsTable.appendChild(fourthRow);

        // Fifth Row ///////////////////////////////////////////////////////////
        const fifthRow = document.createElement('tr');
        detailsTable.appendChild(fifthRow);

        // Timestamp
        const timestampColumnElement = document.createElement('td');
        timestampColumnElement.colSpan = 4;
        fifthRow.appendChild(timestampColumnElement);
        const timestampElement = document.createTextNode(effectMessage.timestamp);
        timestampColumnElement.appendChild(timestampElement);


        return detailsTable;
      }

      function createTableRowFromArray(elements){
        const newRow = document.createElement('tr');
        elements.forEach(element => {
          const newColumn = document.createElement('td');
          newRow.appendChild(newColumn);
          const content = document.createTextNode(element);
          newColumn.appendChild(content);
        });
        return newRow;
      }

      function createGainedEffectElement(rawData){
        const effectMessage = parseMessageGainEffect(rawData);
        // Container for the Gained Effect messages
        const gainedEffectElement = document.createElement('details');
        gainedEffectElement.classList.add('card');
        gainedEffectElement.classList.add('gainedEffectContainer');

        // Container for the friendly view elements
        const friendlyViewElement = document.createElement('summary');
        friendlyViewElement.classList.add('gainedEffectFriendlyView');
        gainedEffectElement.appendChild(friendlyViewElement);

        // Timestamp
        const friendlyTimestampElement = document.createElement('span');
        const timestamp = new Date(effectMessage.timestamp);
        // Create a friendly, consistently spaced, view of the timestamp
        const hours = effectMessage.timestamp.getHours();
        const friendlyHours = hours < 10 ? '0' + hours : hours;
        const minutes = effectMessage.timestamp.getMinutes();
        const friendlyMinutes = minutes < 10 ? '0' + minutes : minutes;
        const seconds = effectMessage.timestamp.getSeconds();
        const friendlySeconds = seconds < 10 ? '0' + seconds : seconds;
        const milliseconds = effectMessage.timestamp.getMilliseconds();
        const friendlyMilliSeconds = milliseconds < 100 ? '0' + ( milliseconds < 10 ? '0' + milliseconds : milliseconds) : milliseconds;
        friendlyTimestampElement.innerHTML = `${friendlyHours}:${friendlyMinutes}:${friendlySeconds}.${friendlyMilliSeconds}`
        friendlyViewElement.appendChild(friendlyTimestampElement);

        // Actor  applying the effect to the target
        const friendlyActorElement = document.createElement('span');
        friendlyActorElement.innerHTML = `
          <b>${effectMessage.actorName}</b>
          applied
          <b>${effectMessage.actionName}</b>
          to
          <b>${effectMessage.targetName}</b>
        `;
        friendlyViewElement.appendChild(friendlyActorElement);

        // Container for the detailed view
        const detailedView = document.createElement('div');
        gainedEffectElement.appendChild(detailedView);

        // Table to hold the message information
        const gainedEffectTable = createGainedEffectTable(effectMessage)
        detailedView.appendChild(gainedEffectTable);

        // Parsed message view ////////////////////////////////////////////////////
        const codeTagContainer = document.createElement('div');
        codeTagContainer.classList.add('gainedEffectCodeContainer');
        gainedEffectElement.appendChild(codeTagContainer);
        const codeTag = document.createElement('code');
        codeTag.classList.add('wordWrapAnywhere');
        codeTag.innerHTML = JSON.stringify(effectMessage);
        codeTagContainer.appendChild(codeTag);

        // Raw message view ////////////////////////////////////////////////////
        const rawCodeTagContainer = document.createElement('div');
        rawCodeTagContainer.classList.add('gainedEffectCodeContainer');
        gainedEffectElement.appendChild(rawCodeTagContainer);
        const rawCodeTag = document.createElement('code');
        rawCodeTag.classList.add('wordWrapAnywhere');
        rawCodeTag.innerHTML = JSON.stringify(rawData);
        rawCodeTagContainer.appendChild(rawCodeTag);

        return gainedEffectElement;
      }

      function createLostEffectElement(effectMessage){

      }

      /*
      appendElementToMain(
        createGainedEffectElement(
          parseMessageGainEffect(
            createFakeMessageGainEffectMessage()
          )
        )
      );
      */
    </script>
  </footer>
</html>
